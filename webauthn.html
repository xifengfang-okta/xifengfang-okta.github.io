
<html>
    <head>
        <title>webauthn test</title>
<style>
    .retTxt {
        padding-left: 20px;
    }
</style>
        <script type="text/javascript" src="https://unpkg.com/cbor-js-unofficial@0.1.0-a4/cbor.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/herrjemand/Base64URL-ArrayBuffer@latest/lib/base64url-arraybuffer.js"></script>
        <script type="text/javascript">

function binToStr(bin){
  return btoa(new Uint8Array(bin).reduce((s, byte) => s + String.fromCharCode(byte), ''));
};

function strToBin(str) {
  return Uint8Array.from(atob(str), c => c.charCodeAt(0));
};

function getAuthenticatorSelection(){
   var authenticatorAttachment = document.getElementById("authenticatorAttachment").value;
   var residentKey = document.getElementById("residentKey").value;
   var userVerification = document.getElementById("userVerification").value;
   var authenticatorSelection = {
        requireResidentKey: document.getElementById("requireResidentKey").checked,
   }
   if(authenticatorAttachment!="") {
    authenticatorSelection.authenticatorAttachment = authenticatorAttachment;
   }
   if(residentKey!="") {
    authenticatorSelection.residentKey = residentKey;
   }
   if(userVerification!="") {
    authenticatorSelection.userVerification = userVerification;
   }
   return authenticatorSelection;
}

function getUserObj(){
   var userId = document.getElementById("userIdfield").value;
   var userDisplayName = document.getElementById("userDisplayNameField").value;

   if(userDisplayName == "") {
     userDisplayName = userId;
   }
   var userName = document.getElementById("userNameField").value;
   if(userName == "") {
     userName = userId;
   }
   var userObj = {
     id: strToBin(userId),//Uint8Array.from(btoa(userId), c => c.charCodeAt(0)),
     name: userName,
     displayName: userDisplayName 
   }
   return userObj;
}

const publicKeyCredentialCreationOptions = {
    challenge: Uint8Array.from(     // This should be a random binary array
        "challenge", c => c.charCodeAt(0)),   // should be a random string
    rp: {
        name: "test site",
        id: "2acf-69-220-155-165.ngrok.io",
    },
    user: {
        id: Uint8Array.from(
            "id_2", c => c.charCodeAt(0)),
        name: "name_1",
        displayName: "displayname_1",
    },
    pubKeyCredParams: [{alg: -7, type: "public-key"}, {alg: -257, type: "public-key"}],
    authenticatorSelection: {
        authenticatorAttachment: "platform",
	    requireResidentKey: true,
	    residentKey: "required", //"preferred",
	    userVerification: "preferred",
    },
    timeout: 60000,
    //attestation: "direct",
    extensions: {
       credProps: true,
       devicePubKey: true
    }
};

function register() {
   var credId = document.getElementById("credIdfield").value;
   var newCredId = credId.replace(new RegExp('_', 'g'), '/').replace(new RegExp('-', 'g'), '+');
   const credentials = [];
   credentials.push({
	type: 'public-key',
	id: Uint8Array.from(atob(newCredId), c => c.charCodeAt(0)),
   });
   publicKeyCredentialCreationOptions.excludeCredentials = credentials;
   publicKeyCredentialCreationOptions.user = getUserObj();
   publicKeyCredentialCreationOptions.authenticatorSelection = getAuthenticatorSelection();
   navigator.credentials.create({
        publicKey: publicKeyCredentialCreationOptions
   }).then(credential => {

        console.log(credential);
        console.log("extensions:");
        var ext = credential.getClientExtensionResults();
        console.log(ext);
        document.getElementById('extension').innerHTML = JSON.stringify(ext);
        // id: 'ADSUllKQmbqdGtpu4sjseh4cg2TxSvrbcHDTBsv4NSSX9...',
        // rawId: ArrayBuffer(59),
        // response: AuthenticatorAttestationResponse {
        //     clientDataJSON: ArrayBuffer(121),
        //     attestationObject: ArrayBuffer(306),
        // },
        // type: 'public-key'

        // decode the clientDataJSON into a utf-8 string
        const utf8Decoder = new TextDecoder('utf-8');
        const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON)

        // parse the string as an object
        const clientDataObj = JSON.parse(decodedClientData);

        console.log(clientDataObj);
        // note: this challenge is base64url.encode'd of the input binary challenge
        // challenge: "p5aV2uHXr0AOqUk7HQitvi-Ny1....",
        // origin: "https://webauthn.guide",
        // type: "webauthn.create"

        // Parse attestation
        // note: a CBOR decoder library is needed here.
        const decodedAttestationObj = CBOR.decode(credential.response.attestationObject);
        console.log(decodedAttestationObj);

        // authData: Uint8Array(196),
        // fmt: "fido-u2f",
        // attStmt: {
        //     sig: Uint8Array(70),
        //     x5c: Array(1),
        // },

        const {authData} = decodedAttestationObj;

	    // get AAGUID
        const aaguid = authData.slice(37,53);
        const aaguidAscii = base64url.encode(aaguid);
        console.log('aaguid: ' + aaguidAscii);
        document.getElementById("aaguidlist").innerHTML = aaguidAscii;

        // get the length of the credential ID
        const dataView = new DataView(new ArrayBuffer(2));
        const idLenBytes = authData.slice(53, 55);
        idLenBytes.forEach((value, index) => dataView.setUint8(index, value));
        const credentialIdLength = dataView.getUint16();

        // get the credential ID, TO BE STORED on server
        const credentialId = authData.slice(55, 55 + credentialIdLength);
        const credentialIdAscii = base64url.encode(credentialId);
        console.log(credentialId);
        console.log(credentialIdAscii);

        // get the public key object. TO BE STORED on server
        const publicKeyBytes = authData.slice(55 + credentialIdLength);
        console.log(publicKeyBytes);

        // the publicKeyBytes are encoded again as CBOR
        const publicKeyObject = CBOR.decode(publicKeyBytes.buffer);
        console.log(publicKeyObject)

	    document.getElementById("allCredId").innerHTML = document.getElementById("allCredId").innerHTML + "<br />" + credentialIdAscii;
        // 1: 2,
        // 3: -7,
        // -1: 1,
        // -2: Uint8Array(32) ...
        // -3: Uint8Array(32) ...
        console.log("registration success");
    }).catch(error => {
        console.log(error);
        document.getElementById('loginResultPannel').innerHTML=error;
    }).finally( () => {
        console.log("finally for registration");
    });
}

const publicKeyCredentialRequestOptions = {
    challenge: Uint8Array.from("challenge", c => c.charCodeAt(0)),  // should be a random string
    allowCredentials: [{
        //id: base64url.decode(credentialId2New),
        type: 'public-key',
        transports: ['internal'],
    }
    ],
    timeout: 60000,
}

function login() {
    var credid = document.getElementById("credIdfield").value;
    if(credid != '') {
      publicKeyCredentialRequestOptions.allowCredentials[0].id = base64url.decode(credid);
    } else {
      publicKeyCredentialRequestOptions.allowCredentials = [];
    }
    navigator.credentials.get({
        publicKey: publicKeyCredentialRequestOptions
    }).then( assertion => {

	    document.getElementById('loginResultPannel').innerHTML = "Login Success";
        console.log("assertion:");
        console.log(assertion);

        const userHandle = assertion.response.userHandle;
        const userHandleBtoA = binToStr(userHandle);
        console.log("userHandleBtoA:" + userHandleBtoA);
        document.getElementById("userHandle").innerHTML = userHandleBtoA;

        //const base64DecodedUserHandle = base64url.decode(userHandleBtoA);
        //console.log(base64DecodedUserHandle);

        //const decodedUserHandleFinal = binToStr(base64DecodedUserHandle);
        //console.log("final UserId:" + decodedUserHandleFinal);

    
        // TODO, verify signature on the server side
        console.log("login successfully");
    }).catch(error => {
        console.log(error);
	document.getElelmentById('loginResultPannel').innerHTML=error;
    }).finally( () => {
        console.log("finally for login");
    });
}

</script>
</head>
<body onload="">

<h1>WebAuthn experience demo</h1>

<h2>Test authenticator enrollment experience</h2>
<button style="height:80px;width:300px; cursor: pointer;" onclick="register()">Register</button>
<button style="height:80px;width:300px; cursor: pointer;" onclick="login()">Login</button><br/><br/>

<br/>
<div>AuthenticatorSelection:<br/>
    <div style="margin-left: 20px;">
        <label for="authenticatorAttachment">authenticatorAttachment</label>
        <select id="authenticatorAttachment"><option value="platform">platform</option><option value="cross-platform">cross-platform</option><option value="">all</option></select>

        <br />
        <label for="requireResidentKey">requireResidentKey</label>
        <input type="checkbox" id="requireResidentKey" checked />

        <br />
        <label for="residentKey">residentKey</label>
        <select id="residentKey"><option value="required">required</option><option value="preferred">preferred</option><option value="discouraged">discouraged</option></select>

        <br />
        <label for="userVerification">userVerification</label>
        <select id="userVerification"><option value="preferred">preferred</option><option value="required">required</option><option value="discouraged">discouraged</option></select>
    </div>
</div>

<br/>
<div>CredId:<br/><input type=text style="width:100%"  id="credIdfield" /></div>

<br/>
<div>UserId:<br/><input type=text id="userIdfield" value="abcd"></div>

<br/>
<div>userDisplayName:<br/><input type=text size=200 id="userDisplayNameField" value=""></div>

<br/>
<div>userName:<br/><input type=text size=200 id="userNameField" value=""></div><br/>


<br/>
<b>CredIds</b>
<div id="allCredId" class="retTxt"></div>

<br/>
<b>AAGUID List</b> <br/>
<div id="aaguidlist" class="retTxt"></div>

<br/>
<b>UserHandle</b> <br/>
<div id="userHandle" class="retTxt"></div>


<br/>
<b>extension</b> <br/>
<div id="extension" class="retTxt"></div>

<br/>
<b>Result</b>
<div id="loginResultPannel" class="retTxt"></div>

</body>
</html>
